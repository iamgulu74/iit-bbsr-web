<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>NEO Earth Encounter 3D - Cosmic Watch</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    <!-- Google Fonts Roboto -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700;900&display=swap" />
    <!-- MDB -->
    <link rel="stylesheet" href="/css/mdb.min.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/app.css" />
    <style>
        body {
            background-color: #000;
            overflow: hidden;
            margin: 0;
            padding: 0;
            /* Override global padding for full-screen canvas */
        }

        #canvas-container {
            width: 100%;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 10;
            pointer-events: none;
        }

        #mainNav {
            pointer-events: auto;
        }

        .legend-box {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            color: white;
            font-family: 'Roboto', sans-serif;
            pointer-events: auto;
            backdrop-filter: blur(5px);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .controls-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            pointer-events: none;
        }
    </style>
</head>

<body>
    <!-- UI Layer -->
    <div id="ui-layer">
        <div id="mainNav"></div>

        <div class="legend-box">
            <h6 class="fw-bold mb-3 border-bottom pb-2">Orbit Legend</h6>
            <div class="legend-item">
                <div class="dot" style="background: #22A6F2; box-shadow: 0 0 5px #22A6F2;"></div>
                <span>Earth</span>
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #aaaaaa;"></div>
                <span>Moon</span>
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #ff3333; box-shadow: 0 0 5px #ff3333;"></div>
                <span>Hazardous Asteroid</span>
            </div>
            <div class="legend-item">
                <div class="dot" style="background: #888888;"></div>
                <span>Safe Asteroid</span>
            </div>
        </div>

        <div class="controls-info">
            <p class="mb-0"><i class="fas fa-mouse me-2"></i>Left: Rotate | Right: Pan | Scroll: Zoom</p>
        </div>
    </div>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <!-- App Scripts -->
    <script type="text/javascript" src="/js/mdb.umd.min.js"></script>
    <script type="text/javascript" src="/js/app/config.js?v=10"></script>
    <script type="text/javascript" src="/js/app/auth.js?v=10"></script>
    <script type="text/javascript" src="/js/app/nav.js?v=10"></script>

    <!-- Earth & Asteroids Logic -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- Configuration ---
        const CONFIG = {
            earthRadius: 3,
            moonRadius: 0.8,
            moonDistance: 15,
            asteroidCount: 100,
            hazardousRatio: 0.2 // 20% are hazardous
        };

        // --- Setup ---
        const container = document.getElementById('canvas-container');
        const scene = new THREE.Scene();

        // Camera
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(20, 10, 20);

        // Renderer
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        container.appendChild(renderer.domElement);

        // Controls
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 0.5;

        // --- Lighting ---
        const ambientLight = new THREE.AmbientLight(0x222222);
        scene.add(ambientLight);

        // Sun Directional Light (Simulating sun from far away)
        const sunLight = new THREE.DirectionalLight(0xffffff, 2);
        sunLight.position.set(50, 20, 30);
        scene.add(sunLight);

        // Backlight for atmosphere effect
        const backLight = new THREE.DirectionalLight(0x445566, 0.5);
        backLight.position.set(-50, -20, -30);
        scene.add(backLight);

        // --- Objects ---

        // 1. Stars Background
        const starGeo = new THREE.BufferGeometry();
        const starCount = 6000;
        const posArray = new Float32Array(starCount * 3);
        const colArray = new Float32Array(starCount * 3);

        for (let i = 0; i < starCount * 3; i += 3) {
            // Random position in sphere
            const r = 200 + Math.random() * 300;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.acos(2 * Math.random() - 1);

            posArray[i] = r * Math.sin(phi) * Math.cos(theta);
            posArray[i + 1] = r * Math.sin(phi) * Math.sin(theta);
            posArray[i + 2] = r * Math.cos(phi);

            // Random star colors (bluish to reddish)
            const starType = Math.random();
            let color = new THREE.Color();
            if (starType > 0.9) color.setHex(0xbbccff); // Blue giant
            else if (starType > 0.7) color.setHex(0xffddaa); // Yellow
            else color.setHex(0xffffff); // White

            colArray[i] = color.r;
            colArray[i + 1] = color.g;
            colArray[i + 2] = color.b;
        }

        starGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        starGeo.setAttribute('color', new THREE.BufferAttribute(colArray, 3));

        const starMat = new THREE.PointsMaterial({
            size: 0.3,
            vertexColors: true,
            transparent: true,
            opacity: 0.8
        });
        const stars = new THREE.Points(starGeo, starMat);
        scene.add(stars);

        // 2. Earth Group
        const earthGroup = new THREE.Group();
        scene.add(earthGroup);

        const textureLoader = new THREE.TextureLoader();

        // EARTH MESH
        const earthGeo = new THREE.SphereGeometry(CONFIG.earthRadius, 64, 64);
        const earthMat = new THREE.MeshPhongMaterial({
            map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_atmos_2048.jpg'),
            specularMap: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_specular_2048.jpg'),
            normalMap: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_normal_2048.jpg'),
            specular: new THREE.Color(0x333333),
            shininess: 15
        });
        const earth = new THREE.Mesh(earthGeo, earthMat);
        earthGroup.add(earth);

        // CLOUDS MESH
        const cloudGeo = new THREE.SphereGeometry(CONFIG.earthRadius * 1.02, 64, 64);
        const cloudMat = new THREE.MeshPhongMaterial({
            map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/earth_clouds_1024.png'),
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            side: THREE.DoubleSide
        });
        const clouds = new THREE.Mesh(cloudGeo, cloudMat);
        earthGroup.add(clouds);

        // ATMOSPHERE GLOW (Shader-like effect using sprite)
        const atmosGeo = new THREE.SphereGeometry(CONFIG.earthRadius * 1.15, 64, 64);
        const atmosMat = new THREE.MeshLambertMaterial({
            color: 0x44aaff,
            transparent: true,
            opacity: 0.1,
            side: THREE.BackSide,
            blending: THREE.AdditiveBlending
        });
        const atmosphere = new THREE.Mesh(atmosGeo, atmosMat);
        earthGroup.add(atmosphere);

        // 3. Moon
        const moonGroup = new THREE.Group(); // Pivot point for moon orbit
        scene.add(moonGroup);

        const moonGeo = new THREE.SphereGeometry(CONFIG.moonRadius, 32, 32);
        const moonMat = new THREE.MeshStandardMaterial({
            map: textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/planets/moon_1024.jpg'),
            roughness: 0.8
        });
        const moon = new THREE.Mesh(moonGeo, moonMat);
        moon.position.set(CONFIG.moonDistance, 0, 0);
        moonGroup.add(moon);

        // Moon Orbit Path (Visual)
        const moonOrbitPoints = new THREE.EllipseCurve(0, 0, CONFIG.moonDistance, CONFIG.moonDistance, 0, 2 * Math.PI).getPoints(100);
        const moonOrbitGeo = new THREE.BufferGeometry().setFromPoints(moonOrbitPoints);
        const moonOrbitMat = new THREE.LineBasicMaterial({ color: 0x555555, transparent: true, opacity: 0.3 });
        const moonOrbit = new THREE.Line(moonOrbitGeo, moonOrbitMat);
        moonOrbit.rotation.x = Math.PI / 2;
        scene.add(moonOrbit);

        // 4. Asteroids (NEOs)
        const asteroids = [];
        const asteroidOrbits = new THREE.Group();
        scene.add(asteroidOrbits);

        for (let i = 0; i < CONFIG.asteroidCount; i++) {
            const isHazardous = Math.random() < CONFIG.hazardousRatio;

            // Create visible asteroid mesh
            const size = 0.1 + Math.random() * 0.2;
            const geo = new THREE.DodecahedronGeometry(size, 0); // Low poly rock
            const mat = new THREE.MeshStandardMaterial({
                color: isHazardous ? 0xff4444 : 0x888888,
                roughness: 0.8
            });
            const mesh = new THREE.Mesh(geo, mat);

            // Generate Random Approach Orbit (Simulating flybys and crossing orbits)
            // They follow elliptical paths that center roughly around earth 
            // (Simulating Relative Motion)

            const radiusX = 10 + Math.random() * 30; // Wide variety of distances
            const radiusZ = 10 + Math.random() * 30;
            const tiltX = (Math.random() - 0.5) * Math.PI; // Random inclination
            const tiltY = (Math.random() - 0.5) * Math.PI;
            const speed = 0.002 + Math.random() * 0.01;
            const offsetStart = Math.random() * Math.PI * 2;

            // Store data
            const asteroidData = {
                mesh: mesh,
                radiusX: radiusX,
                radiusZ: radiusZ,
                speed: speed,
                angle: offsetStart,
                tiltX: tiltX,
                tiltY: tiltY,
                isHazardous: isHazardous
            };
            asteroids.push(asteroidData);
            scene.add(mesh);

            // Draw Orbit Path (Only for some to reduce clutter)
            if (Math.random() > 0.7 || isHazardous) {
                const curve = new THREE.EllipseCurve(
                    0, 0, radiusX, radiusZ,
                    0, 2 * Math.PI,
                    false, 0
                );
                const points = curve.getPoints(64);
                const pathGeo = new THREE.BufferGeometry().setFromPoints(points);
                const pathMat = new THREE.LineBasicMaterial({
                    color: isHazardous ? 0xff0000 : 0x444444,
                    transparent: true,
                    opacity: isHazardous ? 0.3 : 0.1
                });
                const pathLine = new THREE.Line(pathGeo, pathMat);

                // Keep the path aligned with asteroid's rotation logic (tricky in Three.js)
                // Instead, we put the path in a container group rotated same way
                const pathGroup = new THREE.Group();
                pathGroup.rotation.x = Math.PI / 2 + tiltX;
                pathGroup.rotation.y = tiltY;
                pathGroup.add(pathLine);
                asteroidOrbits.add(pathGroup);
            }
        }


        // --- Animation Loop ---
        function animate() {
            requestAnimationFrame(animate);

            // Rotate Earth
            earth.rotation.y += 0.0005;
            clouds.rotation.y += 0.0007; // Clouds move slightly faster
            atmosphere.rotation.y += 0.0005;

            // Rotate Moon Orbit
            moonGroup.rotation.y += 0.005;
            moon.rotation.y += 0.01; // Moon phases

            // Move Asteroids
            asteroids.forEach(ast => {
                ast.angle += ast.speed;

                // Calculate position on flat ellipse
                const x = Math.cos(ast.angle) * ast.radiusX;
                const z = Math.sin(ast.angle) * ast.radiusZ;

                // Apply tilts manually (Rotation Matrix logic simplified)
                // 1. Tilt X
                let y = z * Math.sin(ast.tiltX);
                let zNew = z * Math.cos(ast.tiltX);

                // 2. Tilt Y
                let xFinal = x * Math.cos(ast.tiltY) - zNew * Math.sin(ast.tiltY);
                let zFinal = x * Math.sin(ast.tiltY) + zNew * Math.cos(ast.tiltY);

                ast.mesh.position.set(xFinal, y, zFinal);

                // Tumble asteroid
                ast.mesh.rotation.x += 0.01;
                ast.mesh.rotation.z += 0.01;
            });

            // Slowly rotate background stars
            stars.rotation.y -= 0.0001;

            controls.update();
            renderer.render(scene, camera);
        }

        animate();

        // --- Window Resize ---
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>

</html>
